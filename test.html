<html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<head>
</head>
<style>
#info {
  position: absolute;
  top: 0px;
  width: 100%;
  padding: 10px;
  text-align: center;
  color: #ffff00
}

body {
  overflow: hidden;
}
</style>
<body>

<div id="info"><button id="play" style="width:20%">Play Background  Music</button> </div>
<script src="https://threejs.org/build/three.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>


<audio id="collisionsound" autoplay loop style="display:none">
<source src="https://twhikari.github.io/GP/sound/collision.wav" type='audio/wav'>
</audio>
<audio id="soundtrack" autoplay loop style="display:none">
<source src="https://twhikari.github.io/GP/sound/animals.mp3" type='audio/mp3'>
</audio>

<script>

$('#play').click ( function() {
	isPaused = !isPaused;
	if (isPaused) { 
		$('#play').text ('Play')
		soundTrack.pause()
	} else {
		$('#play').text ('Pause')
		soundTrack.play()
	}
});

function collision_wall(){
  var audio = document.createElement("audio");
  audio.src = "https://twhikari.github.io/GP/sound/collision.wav";
  audio.volume = 0.8;
  audio.play();
}
/*
function collision_wall(){
  var audio = document.createElement("audio");
  audio.src = "collision_wall.wav";
  audio.volume = 0.2;
  audio.play();
}
*/

var camera, scene, renderer;
var pucks;
//var pos, vel, force =  new THREE.Vector3(0,0,0);;
var walls = [];
var puck,puckcolor,pucklight; 
var soundTrack,soundVal = 0.2, sign = 0.1;
var isPaused = true;
var pucks = [];
var ball ;
var dt = 0.1;
var eps = 1e-3; // 0.001 
var cR = 1.0;

  


init();
animate();

function init() {
	
	//collisionsound = document.getElementById ('collisionsound');
	soundTrack = document.getElementById ('soundtrack');
	//collisionsound.volume = 0.8;
	
  class Puck{
	constructor(pos, vel){
		this.materialCylinder =  new THREE.MeshLambertMaterial({color:Math.random() * 0xffffff })
		this.puck = new THREE.Mesh (  new THREE.CylinderGeometry (4, 4, 4, 20), this.materialCylinder );
		this.puck.position.set ( (Math.random()*-95)+(Math.random()*95), 2, (Math.random()*-95)+(Math.random()*95));
		this.force = new THREE.Vector3(0, 0, 0);
		this.vel = new THREE.Vector3(Math.random()*30, 0, Math.random()*30);
		this.pos = this.puck.position;
		scene.add (this.puck);
		this.pucklight = new THREE.PointLight( this.materialCylinder.color, 1,100);
		this.pucklight.position.copy (this.puck.position);
		this.pucklight.position.y += 10;
		scene.add (this.pucklight);
		
	}
	rebirth() {
	this.vel.add (this.force.clone().multiplyScalar(dt));
	this.pos.add (this.vel.clone().multiplyScalar(dt));
	this.pucklight.position.copy (this.puck.position);
	this.pucklight.position.y += 10;		
	for (let i = 0; i < walls.length; i++) {
		let wall = walls[i];	
		if (this.pos.clone().sub (wall.point).dot (wall.normal) < eps + 4 && this.vel.clone().dot(wall.normal) < 0) {
		//	let box = new THREE.Box3();
		//	box.setFromObject(wall);
		//	let circle = { center: new THREE.Vector3(this.pos.x, 0, this.pos.z), rad: 5 };
		//	let rect = { min: new THREE.Vector3(box.min.x, 0, box.min.z), max: new THREE.Vector3(box.max.x, 0, box.max.z) };
							
		//	if (this.checkIntersect(circle, rect)) {
			collision_wall();
			var vN = wall.normal.clone().multiplyScalar(this.vel.dot (wall.normal));
			var vT = this.vel.clone().sub(vN);
			this.vel.copy ( vT.add (vN.multiplyScalar(-cR) ));			
			this.puck.position.add(wall.normal.clone().multiplyScalar(5-this.pos.clone().sub (wall.point).dot(wall.normal)));
			this.pos = this.puck.position;		
						}
		}
	
	  }
  }
/*
  vel.add (force.clone().multiplyScalar(dt));
  pos.add (vel.clone().multiplyScalar(dt));
for (i = 0; i < walls.length; i++) {
  	let wall = walls[i];
	//for(j = 0; j < puckks.length; j++){
		//let puck = puckks[j];
		//pos = puck.pos.clone();
		if (pos.clone().sub (wall.point).dot (wall.normal) < eps + 15) {
		var vN = wall.normal.clone().multiplyScalar(vel.dot (wall.normal));
		var vT = vel.clone().sub(vN);
		// vel = vT + (- CR).vN
		vel.copy (vT.add (vN.multiplyScalar(-cR) ));
		}
	}
}	*/
  class wall{
	constructor(){
		this.wall = new THREE.Mesh (new THREE.BoxGeometry (), new THREE.MeshPhongMaterial());;
		
	}

  }
  

  /* wall = new THREE.Mesh (new THREE.BoxGeometry (220, 20,10), material);
  scene.add (wall);
  wall.position.set (0, 10, 105);
  wall.point = new THREE.Vector3(0,0,100);
  wall.normal = new THREE.Vector3(0,0,-1);
  walls.push (wall);*/
  
  
  
  scene = new THREE.Scene();

  renderer = new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(0xf2bfea);
  document.body.appendChild(renderer.domElement);

  camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
  camera.position.y = 400;
  camera.position.z = 400;
  camera.lookAt (0,0,0);
  let controls = new THREE.OrbitControls(camera, renderer.domElement);

  
  
  for (let i = 0; i < 1; i++) {
  	let ball = new Puck();
  	pucks.push (ball);
//	let thisMesh = ballMesh.clone();
  //	ballMeshes.push (thisMesh);
   
  }

  ////////////////////////////////////////////////////////////////
  
  var floor = new THREE.Mesh (new THREE.PlaneGeometry(200,200,200), new THREE.MeshPhongMaterial({color: 0x68706a}));
  scene.add (floor);
  floor.rotation.x = -Math.PI/2;
  
  /*let geometry = new THREE.BoxGeometry( 200, 1, 200 );
				let materiall = new THREE.MeshPhongMaterial( {color: 0x68706a} );
				let ground = new THREE.Mesh( geometry, materiall );
				scene.add( ground );*/
  
 
  
  //////light
  puckcolor = new THREE.MeshLambertMaterial({color:Math.random() * 0xffffff })
  puck = new THREE.Mesh (new THREE.CylinderGeometry (15,15,4,20), puckcolor);
  scene.add (puck)
  puck.position.y = 2;
  
  pucklight = new THREE.PointLight( puckcolor.color, 1,100);
  //pucklight.position.set( 50, 50, 50 );
  scene.add( pucklight );


  var light = new THREE.AmbientLight( 0x101010 ); // soft white light
 // scene.add( light );
  
  var light2 = new THREE.PointLight( 0x000000,0.8);
//scene.add( light2 );
  
  
  var hemiLight = new THREE.HemisphereLight(0xffffff, 0xffffff); 
  scene.add(hemiLight);
  /// boundary
  
  var material = new THREE.MeshPhongMaterial ( {color: 0x6f6965, opacity: 0.7, transparent: true} );
  
  w = new wall();
  w = new THREE.Mesh (new THREE.BoxGeometry (10, 20,200), material);
  scene.add (w);
  w.position.set (105, 10, 0);
  w.point = new THREE.Vector3(100,0,0);
  w.normal = new THREE.Vector3(-1,0,0);
  walls.push (w);
  
  w = new THREE.Mesh (new THREE.BoxGeometry (10, 20,200), material);
  scene.add (w);
  w.position.set (-105, 10, 0);
  w.point = new THREE.Vector3(-100,0,0);
  w.normal = new THREE.Vector3(1,0,0);
  walls.push (w);
  
  w = new THREE.Mesh (new THREE.BoxGeometry (220, 20,10), material);
  scene.add (w);
  w.position.set (0, 10, -105);
  w.point = new THREE.Vector3(0,0,-100);
  w.normal = new THREE.Vector3(0,0,1);
  walls.push (w);
  
  w = new THREE.Mesh (new THREE.BoxGeometry (220, 20,10), material);
  scene.add (w);
  w.position.set (0, 10, 105);
  w.point = new THREE.Vector3(0,0,100);
  w.normal = new THREE.Vector3(0,0,-1);
  walls.push (w);
  
  
  ///////////////
  
	
  
  
  
 // force = new THREE.Vector3(0,0,0);
  vel = new THREE.Vector3((Math.random()*-10)+(Math.random()*10), 0, (Math.random()*-10)+(Math.random()*10));
  pos = new THREE.Vector3();
  
}

function animate() {
		
		pucks.forEach(function(p){
					p.rebirth();
				});
 
  // Euler's method
  let force = new THREE.Vector3(0,0,0);
  vel.add (force.clone().multiplyScalar(dt));
  pos.add (vel.clone().multiplyScalar(dt));
  puck.position.copy (pos);
  puck.position.y += 2;
//  pucklight.color.copy(puck.color);
  pucklight.position.copy (puck.position);
  pucklight.position.y += 10;
  
  // collision detection
  for (i = 0; i < walls.length; i++) {
  	let wall = walls[i];
	//for(j = 0; j < puckks.length; j++){
		//let puck = puckks[j];
		//pos = puck.pos.clone();
		if (pos.clone().sub (wall.point).dot (wall.normal) < eps + 15) {
		var vN = wall.normal.clone().multiplyScalar(vel.dot (wall.normal));
		var vT = vel.clone().sub(vN);
		// vel = vT + (- CR).vN
		vel.copy (vT.add (vN.multiplyScalar(-cR) ));
		}
	}
	
	soundVal += sign*0.01;
	soundVal = THREE.Math.clamp (0.1, 0, 1);
	soundtrack.volume = soundVal;
	
	
  
  
  
  requestAnimationFrame(animate);
  render();

}

function render() {

  renderer.render(scene, camera);

}




</script>

</body>

</html>
